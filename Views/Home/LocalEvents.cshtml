<!-- Views/Home/LocalEvents.cshtml -->
@model List<Programming_7312_Part_1.Models.Event>

@{
    ViewData["Title"] = "Local Events and Announcements";
    var images = new[] { "comunity.jpg", "crime.jpg", "hippo.png", "newlands.jpg", "pothole.jpg", "tokai.jpeg" }; // hardcoded images from the wwwroot folder for startup. this allows someone to run this for the first time and have images displaying on th eevents. when an admin adds images it get s stored in the uploads folder 
    int imageIndex = 0; 
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - Municipal Services</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="~/css/futuristic-styles.css" rel="stylesheet">
    <link href="~/css/site.css" rel="stylesheet">
    <style>
        .event-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

            .event-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            }

        .event-image {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }

        .event-date-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .featured-section, .upcoming-section, .recommended-section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #000000;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }

            .section-title:after {
                content: '';
                position: absolute;
                width: 50px;
                height: 3px;
                background-color: #000000;
                bottom: -5px;
                left: 0;
            }

        .category-filter {
            margin-bottom: 20px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .event-tag {
            display: inline-block;
            background-color: #e9ecef;
            color: #000000;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .no-events {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Animated background - hidden -->
    <div class="particles" style="display: none;">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <div class="events-container">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <!-- Page Title -->
                    <div class="page-title">
                        <h1 class="glowing-text">Local Events & Announcements</h1>
                        <p class="subtitle">Stay informed about what's happening in your community</p>
                        <!-- Announcements Button -->
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary neon-button" onclick="scrollToAnnouncement()">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="neon-card mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="search-box">
                                    <div class="input-group">
                                        <input type="text" id="searchInput" class="form-control neon-input" placeholder="Search events..." value="@ViewBag.SearchTerm">
                                        <button class="btn btn-primary neon-button" type="button" id="searchButton">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="category-filter">
                                        <select id="categoryFilter" class="form-select neon-select">
                                            <option value="">All Categories</option>
                                            <option value="Popular" selected="@(ViewBag.SelectedCategory == "Popular")">Popular</option>
                                            @if (ViewBag.Categories != null)
                                            {
                                                @foreach (string category in ViewBag.Categories)
                                                {
                                                    <option value="@category" selected="@(ViewBag.SelectedCategory == category)">@category</option>
                                                }
                                            }
                                        </select>
                                    </div>
                            </div>
                            <div class="col-md-3">
                                <div class="date-filter">
                                    <div class="input-group">
                                        <input type="date" id="startDate" class="form-control neon-input" value="@(ViewBag.StartDate?.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))" min="@DateTime.Now.ToString("yyyy-MM-dd")" title="Start Date">
                                        <span class="input-group-text">to</span>
                                        <input type="date" id="endDate" class="form-control neon-input" value="@ViewBag.EndDate?.ToString("yyyy-MM-dd")" min="@DateTime.Now.ToString("yyyy-MM-dd")" title="End Date">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Events Section -->
                    @if (ViewBag.RecommendedEvents != null && ViewBag.RecommendedEvents.Count > 0)
                    {
                        <div class="recommended-section">
                            <h3 class="section-title">Recommended For You</h3>
                            <div class="row">
                                @foreach (var eventItem in ViewBag.RecommendedEvents)
                                {
                                    <div class="col-md-4">
                                        <div class="event-card neon-card">
                                            <div class="position-relative">
                                                <img src="~/Images/@(images[imageIndex++ % images.Length])" class="event-image" alt="@eventItem.Title">
                                                <div class="event-date-badge">
                                                    <i class="far fa-calendar-alt"></i> @eventItem.EventDate.ToString("MMM dd")
                                                </div>
                                            </div>
                                            <div class="p-3">
                                                <h5>@eventItem.Title</h5>
                                                <p class="text-muted small">
                                                    <i class="fas fa-map-marker-alt"></i> @eventItem.Location
                                                </p>
                                                <p class="card-text">@(eventItem.Description.Length > 100 ? eventItem.Description.Substring(0, 100) + "..." : eventItem.Description)</p>
                                                <div class="mb-2">
                                                    <span class="event-tag">@eventItem.Category</span>
                                                </div>
                                                <div class="mb-2 d-flex align-items-center">
                                                    <button class="btn btn-sm btn-success me-2 vote-btn" data-event-id="@eventItem.Id" data-vote-type="upvote">
                                                        <i class="fas fa-thumbs-up"></i> <span class="upvote-count">@eventItem.Upvotes</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger vote-btn" data-event-id="@eventItem.Id" data-vote-type="downvote">
                                                        <i class="fas fa-thumbs-down"></i> <span class="downvote-count">@eventItem.Downvotes</span>
                                                    </button>
                                                </div>
                                                <a href="#" class="btn btn-sm btn-outline-primary neon-button">View Details</a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Featured Events Section -->
                    @if (ViewBag.FeaturedEvents != null && ViewBag.FeaturedEvents.Count > 0)
                    {
                        <div class="featured-section">
                            <h3 class="section-title">Featured Events</h3>
                            <div class="row">
                                @foreach (var eventItem in ViewBag.FeaturedEvents)
                                {
                                    <div class="col-md-4">
                                        <div class="event-card neon-card">
                                            <div class="position-relative">
                                                <img src="~/Images/@(images[imageIndex++ % images.Length])" class="event-image" alt="@eventItem.Title">
                                                <div class="event-date-badge">
                                                     <i class="far fa-calendar-alt"></i> @eventItem.EventDate.ToString("MMM dd")
                                                 </div>
                                            </div>
                                            <div class="p-3">
                                                <h5>@eventItem.Title</h5>
                                                <p class="text-muted small">
                                                    <i class="fas fa-map-marker-alt"></i> @eventItem.Location
                                                </p>
                                                <p class="card-text">@(eventItem.Description.Length > 100 ? eventItem.Description.Substring(0, 100) + "..." : eventItem.Description)</p>
                                                <div class="mb-2">
                                                    <span class="event-tag">@eventItem.Category</span>
                                                </div>
                                                <div class="mb-2 d-flex align-items-center">
                                                    <button class="btn btn-sm btn-success me-2 vote-btn" data-event-id="@eventItem.Id" data-vote-type="upvote">
                                                        <i class="fas fa-thumbs-up"></i> <span class="upvote-count">@eventItem.Upvotes</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger vote-btn" data-event-id="@eventItem.Id" data-vote-type="downvote">
                                                        <i class="fas fa-thumbs-down"></i> <span class="downvote-count">@eventItem.Downvotes</span>
                                                    </button>
                                                </div>
                                                <a href="#" class="btn btn-sm btn-outline-primary neon-button">View Details</a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Upcoming Events Section -->
                    @if (ViewBag.UpcomingEvents != null && ViewBag.UpcomingEvents.Count > 0)
                    {
                        <div class="upcoming-section">
                            <h3 class="section-title">Upcoming Events</h3>
                            <div class="row">
                                @foreach (var eventItem in ViewBag.UpcomingEvents)
                                {
                                    <div class="col-md-4">
                                        <div class="event-card neon-card">
                                            <div class="position-relative">
                                                <img src="~/Images/@(images[imageIndex++ % images.Length])" class="event-image" alt="@eventItem.Title">
                                                <div class="event-date-badge">
                                                     <i class="far fa-calendar-alt"></i> @eventItem.EventDate.ToString("MMM dd")
                                                 </div>
                                            </div>
                                            <div class="p-3">
                                                <h5>@eventItem.Title</h5>
                                                <p class="text-muted small">
                                                    <i class="fas fa-map-marker-alt"></i> @eventItem.Location
                                                </p>
                                                <p class="card-text">@(eventItem.Description.Length > 100 ? eventItem.Description.Substring(0, 100) + "..." : eventItem.Description)</p>
                                                <div class="mb-2">
                                                    <span class="event-tag">@eventItem.Category</span>
                                                </div>
                                                <div class="mb-2 d-flex align-items-center">
                                                    <button class="btn btn-sm btn-success me-2 vote-btn" data-event-id="@eventItem.Id" data-vote-type="upvote">
                                                        <i class="fas fa-thumbs-up"></i> <span class="upvote-count">@eventItem.Upvotes</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger vote-btn" data-event-id="@eventItem.Id" data-vote-type="downvote">
                                                        <i class="fas fa-thumbs-down"></i> <span class="downvote-count">@eventItem.Downvotes</span>
                                                    </button>
                                                </div>
                                                <a href="#" class="btn btn-sm btn-outline-primary neon-button">View Details</a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- All Events Section -->
                    <div class="all-events-section">
                        <h3 class="section-title">All Events</h3>

                        @if (Model.Count == 0)
                        {
                            <div class="no-events">
                                <i class="fas fa-calendar-times fa-3x mb-3"></i>
                                <h4>No events found</h4>
                                <p>Try adjusting your search or filter criteria</p>
                            </div>
                        }
                        else
                        {
                            <div class="row">
                                @foreach (var eventItem in Model)
                                {
                                    <div class="col-md-4">
                                        <div class="event-card neon-card">
                                            <div class="position-relative">
                                                <img src="~/Images/@(images[imageIndex++ % images.Length])" class="event-image" alt="@eventItem.Title">
                                                <div class="event-date-badge">
                                                     <i class="far fa-calendar-alt"></i> @eventItem.EventDate.ToString("MMM dd")
                                                 </div>
                                            </div>
                                            <div class="p-3">
                                                <h5>@eventItem.Title</h5>
                                                <p class="text-muted small">
                                                    <i class="fas fa-map-marker-alt"></i> @eventItem.Location
                                                </p>
                                                <p class="card-text">@(eventItem.Description.Length > 100 ? eventItem.Description.Substring(0, 100) + "..." : eventItem.Description)</p>
                                                <div class="mb-2">
                                                    <span class="event-tag">@eventItem.Category</span>
                                                    @if (eventItem.Tags != null && eventItem.Tags.Count > 0)
                                                    {
                                                        foreach (var tag in eventItem.Tags.Take(2))
                                                        {
                                                            <span class="event-tag">@tag</span>
                                                        }
                                                    }
                                                </div>
                                                <div class="mb-2 d-flex align-items-center">
                                                    <button class="btn btn-sm btn-success me-2 vote-btn" data-event-id="@eventItem.Id" data-vote-type="upvote">
                                                        <i class="fas fa-thumbs-up"></i> <span class="upvote-count">@eventItem.Upvotes</span>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger vote-btn" data-event-id="@eventItem.Id" data-vote-type="downvote">
                                                        <i class="fas fa-thumbs-down"></i> <span class="downvote-count">@eventItem.Downvotes</span>
                                                    </button>
                                                </div>
                                                <a href="#" class="btn btn-sm btn-outline-primary neon-button">View Details</a>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Back to Main Menu Button -->
                    <!-- Important Announcements Section -->
                    <div id="announcement" class="announcement-section">
                        <h3 class="section-title">Important Announcements</h3>
                        @if (ViewBag.Announcements != null && ViewBag.Announcements.Count > 0)
                        {
                            <div class="row">
                                @foreach (var announcement in ViewBag.Announcements)
                                {
                                    <div class="col-md-6 mb-3">
                                        <div class="event-card neon-card">
                                            <div class="position-relative">
                                                <img src="~/Images/coat of arms .jpeg" class="event-image" alt="Municipality Announcement">
                                                @if (announcement.Priority == 3)
                                                {
                                                    <div class="event-date-badge bg-danger">
                                                        <i class="fas fa-exclamation-triangle"></i> High Priority
                                                    </div>
                                                }
                                                else if (announcement.Priority == 2)
                                                {
                                                    <div class="event-date-badge bg-warning">
                                                        <i class="fas fa-info-circle"></i> Medium Priority
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="event-date-badge bg-secondary">
                                                        <i class="fas fa-info"></i> Low Priority
                                                    </div>
                                                }
                                            </div>
                                            <div class="p-3">
                                                <h5 class="card-title">@announcement.Title</h5>
                                                @if (!string.IsNullOrEmpty(announcement.Category))
                                                {
                                                    <span class="event-tag">@announcement.Category</span>
                                                }
                                                <p class="card-text">@(announcement.Content.Length > 150 ? announcement.Content.Substring(0, 150) + "..." : announcement.Content)</p>
                                                <small class="text-muted">Posted: @announcement.CreatedDate.ToString("MMM dd, yyyy")</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="event-card neon-card">
                                        <div class="position-relative">
                                            <img src="~/Images/coat of arms .jpeg" class="event-image" alt="Municipality Announcement">
                                        </div>
                                        <div class="p-3">
                                            <p class="card-text">There will be no water in the area of Upper Newlands on 18 November 2025 from 08:00 to 17:00 due to planned maintenance of water infrastructure - Municipality.</p>  <!--dummy announcement -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="text-center mt-4">
                        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-light neon-button">
                            <i class="fas fa-arrow-left"></i> Back to Main Menu
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const categoryFilter = document.getElementById('categoryFilter');

            // Function to perform search
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                const category = categoryFilter.value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                let url = '@Url.Action("LocalEvents", "Home")';
                let params = [];

                if (searchTerm) {
                    params.push('searchTerm=' + encodeURIComponent(searchTerm));
                }

                if (category) {
                    params.push('category=' + encodeURIComponent(category));
                }

                if (startDate) {
                    params.push('startDate=' + encodeURIComponent(startDate));
                }

                if (endDate) {
                    params.push('endDate=' + encodeURIComponent(endDate));
                }

                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                window.location.href = url;
            }

            // Search button click event
            searchButton.addEventListener('click', performSearch);

            // Enter key in search input
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Category filter change event
            categoryFilter.addEventListener('change', function() {
                performSearch();
            });

            // Voting functionality
            document.addEventListener('click', function(e) {
                if (e.target.closest('.vote-btn')) {
                    e.preventDefault();
                    const button = e.target.closest('.vote-btn');
                    const eventId = button.getAttribute('data-event-id');
                    const voteType = button.getAttribute('data-vote-type');

                    // Disable button to prevent multiple clicks
                    button.disabled = true;

                    const url = voteType === 'upvote' ? '@Url.Action("UpvoteEvent", "Home")' : '@Url.Action("DownvoteEvent", "Home")';
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `eventId=${eventId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update vote counts
                            const eventCard = button.closest('.event-card');
                            const upvoteSpan = eventCard.querySelector('.upvote-count');
                            const downvoteSpan = eventCard.querySelector('.downvote-count');

                            upvoteSpan.textContent = data.upvotes;
                            downvoteSpan.textContent = data.downvotes;
                        } else {
                            alert('Failed to register vote. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    })
                    .finally(() => {
                        // Re-enable button
                        button.disabled = false;
                    });
                }
            });

            // Function to scroll to announcement
            window.scrollToAnnouncement = function() {
                const announcement = document.getElementById('announcement');
                if (announcement) {
                    announcement.scrollIntoView({ behavior: 'smooth' });
                }
            };
        });
    </script>
</body>
</html>