@{
    ViewData["Title"] = "Create New Event";
}

<div class="report-container">
    <div class="page-title">
        <h1 class="glowing-text">Create New Event</h1>
        <p class="subtitle">Add a new event to the system</p>
    </div>

    <div class="neon-card">
        <form method="post" enctype="multipart/form-data" action="/Admin/CreateEvent">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="mb-3">
                <label for="Title" class="form-label">Title</label>
                <input id="Title" name="Title" class="form-control neon-input" required />
            </div>

            <div class="mb-3">
                <label for="Description" class="form-label">Description</label>
                <textarea id="Description" name="Description" class="form-control neon-input" rows="4" required></textarea>
            </div>

            <div class="mb-3">
                <label for="Category" class="form-label">Category</label>
                <select id="Category" name="Category" class="form-select neon-select" required>
                    <option value="">Select a category</option>
                    @if (ViewBag.Categories != null)
                    {
                        @foreach (string category in ViewBag.Categories)
                        {
                            <option value="@category">@category</option>
                        }
                    }
                </select>
            </div>

            <div class="mb-3">
                <label for="EventDate" class="form-label">Event Date</label>
                <input id="EventDate" name="EventDate" type="datetime-local" class="form-control neon-input" required min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
            </div>

            <div class="mb-3">
                <label for="Location" class="form-label">Location</label>
                <input id="Location" name="Location" class="form-control neon-input" required />
            </div>

            <div class="mb-3">
                <label class="form-label">Event Image</label>
                <div id="drop-zone" class="drop-zone">
                    <p>Drag and drop an image here or click to select</p>
                    <input type="file" id="imageFile" name="imageFile" accept="image/*" style="display: none;" required />
                </div>
                <div id="preview" class="image-preview" style="display: none;">
                    <img id="preview-img" src="" alt="Preview" />
                    <button type="button" id="remove-image" class="btn btn-sm btn-outline-danger mt-2">Remove Image</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="tagsInput" class="form-label">Tags</label>
                <select id="tagsInput" name="tagsInput" class="form-select neon-select" multiple required>
                    @if (ViewBag.Tags != null)
                    {
                        @foreach (string tag in ViewBag.Tags)
                        {
                            <option value="@tag">@tag</option>
                        }
                    }
                </select>
                <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple tags</small>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary neon-button" id="submitBtn" disabled>Create Event</button>
                <a asp-action="Dashboard" class="btn btn-outline-secondary neon-button">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('imageFile');
            const preview = document.getElementById('preview');
            const previewImg = document.getElementById('preview-img');
            const removeBtn = document.getElementById('remove-image');
            const submitBtn = document.getElementById('submitBtn');
            const requiredFields = ['Title', 'Description', 'Category', 'EventDate', 'Location', 'imageFile', 'tagsInput'];

            function checkFormValidity() {
                let allFilled = true;
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        allFilled = false;
                    }
                });
                submitBtn.disabled = !allFilled;
            }

            // Click to select file
            dropZone.addEventListener('click', function() {
                fileInput.click();
            });

            // File input change
            fileInput.addEventListener('change', function(e) {
                handleFile(e.target.files[0]);
                checkFormValidity();
            });

            // Drag and drop events
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                    checkFormValidity();
                }
            });

            // Remove image
            removeBtn.addEventListener('click', function() {
                fileInput.value = '';
                preview.style.display = 'none';
                dropZone.style.display = 'block';
                checkFormValidity();
            });

            // Add input event listeners to required fields
            requiredFields.forEach(fieldId => {
                if (fieldId !== 'imageFile') {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', checkFormValidity);
                    }
                }
            });

            function handleFile(file) {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                        dropZone.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Initial check
            checkFormValidity();
        });
    </script>
}

<style>
    .drop-zone {
        border: 2px dashed #00ffff;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        background-color: rgba(0, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
        background-color: rgba(0, 255, 255, 0.2);
        border-color: #00ffff;
    }

    .image-preview {
        text-align: center;
        margin-top: 10px;
    }

    .image-preview img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
</style>